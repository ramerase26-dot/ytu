<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏</title>
    <script src="https://cdn.jsdelivr.net/npm/winwheel.js@2.8.0/Winwheel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            text-align: center;
        }
        .container {
            position: relative;
            width: 450px;
            height: 550px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
        }
        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        .spin-button {
            padding: 15px 30px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: background-color 0.3s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .spin-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .spin-button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .pointer {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 30px solid #c0392b;
            z-index: 10;
        }
        #toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 17px;
        }
        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ÿπÿ¨ŸÑÿ© ÿßŸÑÿ≠ÿ∏</h1>
        <div class="wheel-container">
            <div class="pointer"></div>
            <canvas id="canvas" width="400" height="400"></canvas>
        </div>
        <button class="spin-button" id="spin_button" onclick="startSpin();">ÿ™ÿØŸàŸäÿ±!</button>
    </div>
    <div id="toast"></div>

    <script>
        // =================== ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÑÿßÿ≤ŸÖÿ© ===================
        const BOT_TOKEN = '8497054736:AAF_EcYGx5UuEMdRbaYZz8zRCCkVYBwPHq4'; // ÿßÿ≥ÿ™ÿ®ÿØŸÑ ÿ®ÿ±ŸÖÿ≤ ÿßŸÑÿ®Ÿàÿ™ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ
        const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzguqP2vkQaFX-g7KunbXSLngahkkKFnSAwpUI-ilOJtXTMnxbFsI6ShGVXK__NFyH5rA/exec'; // ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿ®ÿØÿßŸÑŸá ŸÑÿßÿ≠ŸÇÿßŸã

        const prizes = [
            {'fillStyle' : '#B0C4DE', 'text' : '5000', 'value': 5000},
            {'fillStyle' : '#ADD8E6', 'text' : '10000', 'value': 10000},
            {'fillStyle' : '#B0C4DE', 'text' : '5%', 'value': '5%'},
            {'fillStyle' : '#ADD8E6', 'text' : '100000', 'value': 100000},
            {'fillStyle' : '#B0C4DE', 'text' : '10%', 'value': '10%'},
            {'fillStyle' : '#ADD8E6', 'text' : '500000', 'value': 500000},
            {'fillStyle' : '#B0C4DE', 'text' : '1000000', 'value': 1000000},
            {'fillStyle' : '#ADD8E6', 'text' : 'ÿ¨ÿ±ÿ® ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ', 'value': 0} // ŸÇÿ≥ŸÖ ÿ•ÿ∂ÿßŸÅŸä ŸÑŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑÿµŸÅÿ±Ÿäÿ©
        ];

        const prizeProbabilities = {
            5000: 5,
            10000: 2,
            '5%': 10,
            100000: 0,
            '10%': 0,
            500000: 0,
            1000000: 0,
            0: 83 // ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ™ÿ®ŸÇŸäÿ©
        };

        // =================== ÿ•ÿπÿØÿßÿØ ÿßŸÑÿπÿ¨ŸÑÿ© ===================
        let theWheel = new Winwheel({
            'numSegments'  : prizes.length,
            'outerRadius'  : 190,
            'innerRadius'  : 30,
            'textFontSize' : 24,
            'textFontFamily' : 'Arial',
            'segments'     : prizes,
            'animation' : {
                'type'     : 'spinToStop',
                'duration' : 10,
                'spins'    : 15,
                'callbackFinished' : alertPrize,
                'callbackSound'    : playSound,
                'soundTrigger'     : 'pin'
            },
            'pins' : {
                'number' : prizes.length * 2,
                'fillStyle' : 'silver',
                'outerRadius': 4,
            }
        });

        let wheelSpinning = false;
        const spinButton = document.getElementById('spin_button');
        const audio = new Audio('https://cdn.jsdelivr.net/gh/dougtesting/winwheel.js/examples/wheel_of_fortune/tick.mp3');

        function playSound() {
            audio.pause();
            audio.currentTime = 0;
            audio.play();
        }

        // =================== ŸÖŸÜÿ∑ŸÇ ÿßŸÑŸÑÿπÿ®ÿ© ===================
        document.addEventListener('DOMContentLoaded', () => {
            const userId = getUserIdFromUrl();
            if (!userId) {
                showToast("ÿÆÿ∑ÿ£: ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ.");
                spinButton.disabled = true;
                return;
            }
            checkUserEligibility(userId);
        });

        function getUserIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        function checkUserEligibility(userId) {
            const lastSpinTime = localStorage.getItem(`lastSpin_${userId}`);
            if (lastSpinTime) {
                const timeDiff = Date.now() - parseInt(lastSpinTime, 10);
                const hoursPassed = timeDiff / (1000 * 60 * 60);
                if (hoursPassed < 24) {
                    spinButton.disabled = true;
                    const hoursLeft = Math.ceil(24 - hoursPassed);
                    showToast(`Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÜÿ™ÿ∏ÿ± ${hoursLeft} ÿ≥ÿßÿπÿ© ÿ£ÿÆÿ±Ÿâ ŸÑŸÑÿ™ÿØŸàŸäÿ±.`);
                    return;
                }
            }
            spinButton.disabled = false;
        }

        function startSpin() {
            if (wheelSpinning) return;

            const userId = getUserIdFromUrl();
            if (!userId) {
                showToast("ÿÆÿ∑ÿ£: ŸÑÿß ŸäŸÖŸÉŸÜ ÿ®ÿØÿ° ÿßŸÑÿ™ÿØŸàŸäÿ± ÿ®ÿØŸàŸÜ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ.");
                return;
            }

            wheelSpinning = true;
            spinButton.disabled = true;
            
            // ÿ≠ÿ≥ÿßÿ® ÿ≤ÿßŸàŸäÿ© ÿßŸÑÿ™ŸàŸÇŸÅ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿßÿ≠ÿ™ŸÖÿßŸÑÿßÿ™
            const stopAt = calculatePrize();
            theWheel.animation.stopAngle = stopAt;
            theWheel.startAnimation();

            localStorage.setItem(`lastSpin_${userId}`, Date.now().toString());
        }

        function calculatePrize() {
            let weightedPrizes = [];
            prizes.forEach(prize => {
                const probability = prizeProbabilities[prize.value] || 0;
                for (let i = 0; i < probability; i++) {
                    weightedPrizes.push(prize.value);
                }
            });

            const randomPrizeValue = weightedPrizes[Math.floor(Math.random() * weightedPrizes.length)];
            const winningSegment = prizes.find(p => p.value === randomPrizeValue);
            
            const segmentAngle = 360 / prizes.length;
            const segmentIndex = prizes.indexOf(winningSegment);
            
            // ÿ™ÿ≠ÿØŸäÿØ ÿ≤ÿßŸàŸäÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ© ÿØÿßÿÆŸÑ ÿßŸÑŸÇÿ∑ÿßÿπ ÿßŸÑŸÅÿßÿ¶ÿ≤
            const stopAt = (segmentIndex * segmentAngle) + Math.floor(Math.random() * segmentAngle);
            return stopAt;
        }

        function alertPrize(indicatedSegment) {
            const prizeText = indicatedSegment.text;
            const prizeValue = indicatedSegment.value;
            const userId = getUserIdFromUrl();

            let message = `üéâ ŸÑŸÇÿØ ŸÅÿ≤ÿ™ ÿ®ŸÄ: ${prizeText} üéâ`;
            if (prizeValue === 0) {
                message = "ÿ≠ÿ∏ÿßŸã ÿ£ŸàŸÅÿ± ŸÅŸä ÿßŸÑŸÖÿ±ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©!";
            }
            showToast(message);
            
            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ±ÿ≥ÿßŸÑÿ© ÿ•ŸÑŸâ ÿ®Ÿàÿ™ ÿßŸÑÿ™ŸÑŸäÿ¨ÿ±ÿßŸÖ
            sendPrizeToBot(userId, prizeText, prizeValue);

            wheelSpinning = false;
            // ŸÑÿß Ÿäÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ≤ÿ± ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ•ŸÑÿß ÿ®ÿπÿØ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        }

        function sendPrizeToBot(userId, prizeText, prizeValue) {
            const text = `/claim_prize ${userId} ${prizeValue} ${prizeText}`;
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${userId}&text=${encodeURIComponent(text)}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Message sent to bot:', data);
                })
                .catch(error => {
                    console.error('Error sending message to bot:', error);
                });
        }

        function showToast(message) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        }

    </script>
</body>
</html>
